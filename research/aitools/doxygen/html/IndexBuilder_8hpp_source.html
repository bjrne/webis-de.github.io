<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>/home/palakars/workspace-inprogress/code-in-progress/aitools3/aitools3-aq-invertedindex-cpp/src/core/IndexBuilder.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>/home/palakars/workspace-inprogress/code-in-progress/aitools3/aitools3-aq-invertedindex-cpp/src/core/IndexBuilder.hpp</h1><a href="IndexBuilder_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (C) 2010 webis.de</span>
<a name="l00002"></a>00002 <span class="comment"> * All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> */</span>
<a name="l00004"></a>00004 <span class="preprocessor">#ifndef AITOOLS_INVERTEDINDEX_INDEX_BUILDER_HPP</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor">#define AITOOLS_INVERTEDINDEX_INDEX_BUILDER_HPP</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;<a class="code" href="System_8hpp.html">System.hpp</a>&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="Record_8hpp.html">Record.hpp</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="Builder_8hpp.html">Builder.hpp</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="Logging_8hpp.html">Logging.hpp</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="Checksum_8hpp.html">Checksum.hpp</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="Converter_8hpp.html">Converter.hpp</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="RecordReader_8hpp.html">RecordReader.hpp</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="StorageBuilder_8hpp.html">StorageBuilder.hpp</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="PostlistSorter_8hpp.html">PostlistSorter.hpp</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="PostlistBuilder_8hpp.html">PostlistBuilder.hpp</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="InvertedFileReader_8hpp.html">InvertedFileReader.hpp</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;boost/algorithm/string.hpp&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;iomanip&gt;</span>
<a name="l00020"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1cf7594aa2edb3cbda97b249c1de377c">00020</a> <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00021"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a2357a8361fc9a15c59e9d3383495a84a">00021</a> 
<a name="l00022"></a>00022 <span class="keyword">namespace </span>aitools {
<a name="l00023"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8c52685830072275be50f8fea0534464">00023</a> <span class="keyword">namespace </span>invertedindex {
<a name="l00024"></a>00024 
<a name="l00034"></a>00034 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00035"></a>00035 <span class="keyword">class </span><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html">IndexBuilder</a> : <span class="keyword">public</span> <a class="code" href="classaitools_1_1invertedindex_1_1Builder.html">Builder</a> {
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="keyword">private</span>: <span class="comment">// nested types</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039         <span class="keyword">typedef</span> std::vector&lt;FILE*&gt;                   <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1cf7594aa2edb3cbda97b249c1de377c">FileVector</a>;
<a name="l00040"></a>00040         <span class="keyword">typedef</span> <a class="code" href="namespaceaitools_1_1invertedindex.html#ab45ffc7d8e94727ca3abad6773d3a8e2">Configuration::Sorting</a>               <a class="code" href="namespaceaitools_1_1invertedindex.html#ab45ffc7d8e94727ca3abad6773d3a8e2">Sorting</a>;
<a name="l00041"></a>00041         <span class="keyword">typedef</span> std::tr1::unordered_map&lt;std::string,
<a name="l00042"></a>00042                 <a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html#afde48f24bee3ea7c357c5f493d1c1463">PostlistBuilder::SharedPointer</a>&gt;      <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8c52685830072275be50f8fea0534464">BuilderMap</a>;
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="keyword">private</span>: <span class="comment">// class data</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         <span class="keyword">static</span> <span class="keyword">const</span> std::string <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8a430030bcc9af7f753cd5f2eebca269">tmp_dir</a>;
<a name="l00047"></a>00047         <span class="keyword">static</span> <span class="keyword">const</span> std::string <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ad3d1129f6bf0a1c9a3427c1b777d6680">tmp_file</a>;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keyword">public</span>: <span class="comment">// class data</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <span class="keyword">static</span> <span class="keyword">const</span> std::string <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#aef6259062e7c5b858034f77819ffe2a4">header_file</a>;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="keyword">public</span>: <span class="comment">// c&#39;tor / d&#39;tor</span>
<a name="l00054"></a>00054 
<a name="l00058"></a>00058         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a016fbc4f308cec1fb42d7115cd230095">IndexBuilder</a>(<a class="code" href="classaitools_1_1invertedindex_1_1RecordReader.html">RecordReader&lt;Value&gt;</a>* reader = <span class="keyword">new</span> <a class="code" href="classaitools_1_1invertedindex_1_1InvertedFileReader.html">InvertedFileReader&lt;Value&gt;</a>);
<a name="l00059"></a>00059 
<a name="l00063"></a>00063         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ae21507ad0b85589e89917d8e7dd2a176">~IndexBuilder</a>();
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">public</span>: <span class="comment">// member</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="keywordtype">void</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a2736508bd2d24095b84fbc2e14c77dbc">build</a>(<span class="keyword">const</span> <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html">Configuration</a>&amp; config) <span class="keywordflow">throw</span> (std::exception);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="keyword">private</span>: <span class="comment">// class member</span>
<a name="l00070"></a>00070 
<a name="l00079"></a>00079         <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1051e3bca98ee901a9d46939c11098d9">build_postlists</a>(<span class="keyword">const</span> bfs::path&amp; path, <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8c52685830072275be50f8fea0534464">BuilderMap</a>&amp; builders)
<a name="l00080"></a>00080         <span class="keywordflow">throw</span> (std::exception);
<a name="l00081"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">00081</a> 
<a name="l00082"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">00082</a>         <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html">Configuration</a>&amp; <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ac0f7f5252c3e340b7e066210bbe4513a">check_config</a>(<span class="keyword">const</span> <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html">Configuration</a>&amp; config)
<a name="l00083"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">00083</a>         throw (std::exception);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         static <span class="keywordtype">void</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a676691b4060cfb45f68f99eac3b1b234">store_header</a>(const <a class="code" href="classaitools_1_1invertedindex_1_1Header.html">Header</a>&amp; header, const bfs::path&amp; path)
<a name="l00086"></a>00086         throw (std::exception);
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         static <span class="keywordtype">void</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a4c6a95b63dff54f6309c64ec7bcfa640">print_header</a>(const <a class="code" href="classaitools_1_1invertedindex_1_1Header.html">Header</a>&amp; header);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 private: <span class="comment">// member</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="keywordtype">void</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#af6775016223d3da0e56897b10a3828ce">index_random_records_</a>() throw (std::exception);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <span class="keywordtype">void</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a82e8b8f09e4d3f5262c922660bf339fe">index_sorted_records_</a>() throw (std::exception);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         bfs::path <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1c685be2be4a7987852f95142501312b">partition_records_</a>() throw (std::exception);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 private: <span class="comment">// data</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         <a class="code" href="classaitools_1_1invertedindex_1_1Header.html">Header</a>               <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>;
<a name="l00101"></a>00101         <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html">Configuration</a>        <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>;
<a name="l00102"></a>00102         <a class="code" href="classaitools_1_1invertedindex_1_1RecordReader.html">RecordReader</a>&lt;<a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;* <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 };
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 template&lt;typename <a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;
<a name="l00107"></a>00107 const std::<span class="keywordtype">string</span>
<a name="l00108"></a>00108 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html">IndexBuilder</a>&lt;<a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;::<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8a430030bcc9af7f753cd5f2eebca269">tmp_dir</a>(&quot;tmp&quot;);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 template&lt;typename <a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;
<a name="l00111"></a>00111 const std::<span class="keywordtype">string</span>
<a name="l00112"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a016fbc4f308cec1fb42d7115cd230095">00112</a> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html">IndexBuilder</a>&lt;<a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;::<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ad3d1129f6bf0a1c9a3427c1b777d6680">tmp_file</a>(&quot;tmp.&quot;);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 template&lt;typename <a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;
<a name="l00115"></a>00115 const std::<span class="keywordtype">string</span>
<a name="l00116"></a>00116 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html">IndexBuilder</a>&lt;<a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;::<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#aef6259062e7c5b858034f77819ffe2a4">header_file</a>(&quot;header&quot;);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 template&lt;typename <a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;
<a name="l00119"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ae21507ad0b85589e89917d8e7dd2a176">00119</a> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html">IndexBuilder</a>&lt;<a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;::<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html">IndexBuilder</a>(<a class="code" href="classaitools_1_1invertedindex_1_1RecordReader.html">RecordReader</a>&lt;<a class="code" href="classaitools_1_1invertedindex_1_1Value.html">Value</a>&gt;* reader)
<a name="l00120"></a>00120 :       reader_(reader)
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122         assert(reader);
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00126"></a>00126 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ae21507ad0b85589e89917d8e7dd2a176">IndexBuilder&lt;Value&gt;::~IndexBuilder</a>()
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128         <span class="keyword">delete</span> <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>;
<a name="l00129"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1051e3bca98ee901a9d46939c11098d9">00129</a> }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="comment">// class member</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00134"></a>00134 <span class="keywordtype">void</span>
<a name="l00135"></a>00135 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1051e3bca98ee901a9d46939c11098d9">IndexBuilder&lt;Value&gt;::build_postlists</a>
<a name="l00136"></a>00136 (<span class="keyword">const</span> bfs::path&amp; path, BuilderMap&amp; builders) <span class="keywordflow">throw</span> (std::exception)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138         <a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html">GenericRecord</a> record;
<a name="l00139"></a>00139         BuilderMap::const_iterator it;
<a name="l00140"></a>00140         BuilderMap::const_iterator end(builders.end());
<a name="l00141"></a>00141         FILE* bucket(<a class="code" href="classaitools_1_1invertedindex_1_1System.html#aca179d3fbbe9047c164806fd4024f8bd">System::fopen</a>(path, <span class="stringliteral">&quot;rb&quot;</span>));
<a name="l00142"></a>00142         <span class="keywordflow">while</span> (record.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a327062eba413c1c00fedf9f92a8a60ca">read</a>(bucket))
<a name="l00143"></a>00143         {
<a name="l00144"></a>00144                 <span class="keywordflow">if</span> ((it = builders.find(record.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>())) == end) <span class="comment">// key is unknown</span>
<a name="l00145"></a>00145                 {
<a name="l00146"></a>00146                         <a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html#afde48f24bee3ea7c357c5f493d1c1463">PostlistBuilder::SharedPointer</a> builder;
<a name="l00147"></a>00147                         builder.reset(<span class="keyword">new</span> <a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html">PostlistBuilder</a>);
<a name="l00148"></a>00148                         builder-&gt;set_checksum(<a class="code" href="classaitools_1_1invertedindex_1_1Checksum.html#ade4ac3b5e85fc603d9663816bec616f8">Checksum::hash16</a>(record.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>()));
<a name="l00149"></a>00149                         it = builders.insert(std::make_pair(record.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>(), builder)).first;
<a name="l00150"></a>00150                 }
<a name="l00151"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ac0f7f5252c3e340b7e066210bbe4513a">00151</a>                 it-&gt;second-&gt;append(record.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a8e8f2bb476c421c888f788a78a4f02c3">value</a>());
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153         <a class="code" href="classaitools_1_1invertedindex_1_1System.html#aafd15be95bdfe3fcba53bae666325bbe">System::fclose</a>(bucket);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00157"></a>00157 <span class="keyword">const</span> Configuration&amp;
<a name="l00158"></a>00158 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ac0f7f5252c3e340b7e066210bbe4513a">IndexBuilder&lt;Value&gt;::check_config</a>(<span class="keyword">const</span> Configuration&amp; config)
<a name="l00159"></a>00159 <span class="keywordflow">throw</span> (std::exception)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161         <span class="keywordflow">if</span> (!bfs::exists(config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a575db839688fc03a75d9044c2dd34035">input_directory</a>()))
<a name="l00162"></a>00162         {
<a name="l00163"></a>00163                 std::string msg(<span class="stringliteral">&quot;Does not exist&quot;</span>);
<a name="l00164"></a>00164                 <a class="code" href="classaitools_1_1invertedindex_1_1Exception.html#ac8e20265b816f35c415ee1ba44ba9d03">Exception::throw_invalid_argument</a>(msg, config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a575db839688fc03a75d9044c2dd34035">input_directory</a>());
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166         <span class="keywordflow">if</span> (!bfs::exists(config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>()))
<a name="l00167"></a>00167         {
<a name="l00168"></a>00168                 std::string msg(<span class="stringliteral">&quot;Does not exist&quot;</span>);
<a name="l00169"></a>00169                 <a class="code" href="classaitools_1_1invertedindex_1_1Exception.html#ac8e20265b816f35c415ee1ba44ba9d03">Exception::throw_invalid_argument</a>(msg, config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>());
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171         <span class="keywordflow">if</span> (bfs::is_empty(config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a575db839688fc03a75d9044c2dd34035">input_directory</a>()))
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173                 std::string msg(<span class="stringliteral">&quot;Is empty&quot;</span>);
<a name="l00174"></a>00174                 <a class="code" href="classaitools_1_1invertedindex_1_1Exception.html#ac8e20265b816f35c415ee1ba44ba9d03">Exception::throw_invalid_argument</a>(msg, config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a575db839688fc03a75d9044c2dd34035">input_directory</a>());
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (!bfs::is_empty(config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>()))
<a name="l00177"></a>00177         {
<a name="l00178"></a>00178                 std::string msg(<span class="stringliteral">&quot;Is not empty&quot;</span>);
<a name="l00179"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a676691b4060cfb45f68f99eac3b1b234">00179</a>                 <a class="code" href="classaitools_1_1invertedindex_1_1Exception.html#ac8e20265b816f35c415ee1ba44ba9d03">Exception::throw_invalid_argument</a>(msg, config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>());
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181         <span class="keywordflow">return</span> config;
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00185"></a>00185 <span class="keywordtype">void</span>
<a name="l00186"></a>00186 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a676691b4060cfb45f68f99eac3b1b234">IndexBuilder&lt;Value&gt;::store_header</a>(<span class="keyword">const</span> Header&amp; header, <span class="keyword">const</span> bfs::path&amp; path)
<a name="l00187"></a>00187 <span class="keywordflow">throw</span> (std::exception)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189         bfs::ofstream ofs(path, std::ios::binary);
<a name="l00190"></a>00190         <span class="keywordflow">if</span> (!ofs)
<a name="l00191"></a>00191         {
<a name="l00192"></a>00192                 <a class="code" href="classaitools_1_1invertedindex_1_1Exception.html#ac8e20265b816f35c415ee1ba44ba9d03">Exception::throw_invalid_argument</a>(<span class="stringliteral">&quot;Cannot create&quot;</span>, path);
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!header.SerializeToOstream(&amp;ofs))
<a name="l00195"></a>00195         {
<a name="l00196"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a4c6a95b63dff54f6309c64ec7bcfa640">00196</a>                 <a class="code" href="classaitools_1_1invertedindex_1_1Exception.html#aa101aebcf8be69da4eca930025e6b27a">Exception::throw_runtime_error</a>(<span class="stringliteral">&quot;Cannot serialize header&quot;</span>);
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198         ofs.close();
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00202"></a>00202 <span class="keywordtype">void</span>
<a name="l00203"></a>00203 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a4c6a95b63dff54f6309c64ec7bcfa640">IndexBuilder&lt;Value&gt;::print_header</a>(<span class="keyword">const</span> Header&amp; header)
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205         <span class="keywordtype">double</span> payload((<span class="keywordtype">double</span>)header.payload() / 1024 / 1024);
<a name="l00206"></a>00206         <span class="keywordtype">double</span> runtime((<span class="keywordtype">double</span>)(header.indexing_duration()) / 60);
<a name="l00207"></a>00207         std::clog &lt;&lt; <span class="stringliteral">&quot;\nNumber of keys    = &quot;</span> &lt;&lt; header.key_count()
<a name="l00208"></a>00208                           &lt;&lt; <span class="stringliteral">&quot;\nNumber of values  = &quot;</span> &lt;&lt; header.value_count()
<a name="l00209"></a>00209                           &lt;&lt; std::fixed &lt;&lt; std::setprecision(2)
<a name="l00210"></a>00210                           &lt;&lt; <span class="stringliteral">&quot;\nData payload size = &quot;</span> &lt;&lt; payload &lt;&lt; <span class="stringliteral">&quot; Megabyte&quot;</span>
<a name="l00211"></a>00211                           &lt;&lt; <span class="stringliteral">&quot;\nIndexing duration = &quot;</span> &lt;&lt; runtime &lt;&lt; <span class="stringliteral">&quot; Minutes\n&quot;</span>
<a name="l00212"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a2736508bd2d24095b84fbc2e14c77dbc">00212</a>                           &lt;&lt; std::endl;
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="comment">// member</span>
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00218"></a>00218 <span class="keywordtype">void</span>
<a name="l00219"></a>00219 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a2736508bd2d24095b84fbc2e14c77dbc">IndexBuilder&lt;Value&gt;::build</a>(<span class="keyword">const</span> <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html">Configuration</a>&amp; config) <span class="keywordflow">throw</span> (std::exception)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221         config_ = check_config(config);
<a name="l00222"></a>00222         header_.set_value_class_name(Value::classname);
<a name="l00223"></a>00223         header_.set_major_version(<a class="code" href="Builder_8hpp.html#a53b956e957f16b7a8d67cbb2275e399f">INDEX_VERSION_MAJOR</a>);
<a name="l00224"></a>00224         header_.set_minor_version(<a class="code" href="Builder_8hpp.html#a3177022bf5461d7ef4a17e25bf19ed18">INDEX_VERSION_MINOR</a>);
<a name="l00225"></a>00225         header_.set_indexing_duration(<a class="code" href="classaitools_1_1invertedindex_1_1Logging.html#a0de768ddb7cf8fa02e1b39f07348893e">Logging::time</a>());
<a name="l00226"></a>00226         header_.set_postlist_sorting(config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#aed00db6b2bea9b3c1606fa307546c2c2">postlist_sorting</a>());
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a1b3df444ac2597ff0c169e958838f80b">input_format</a>() == <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a182fb71c0cdfcb84509f7337a6ef5bf9">Configuration::REAL_INVERTED</a>)
<a name="l00228"></a>00228         {
<a name="l00229"></a>00229                 index_sorted_records_();
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231         <span class="keywordflow">else</span>
<a name="l00232"></a>00232         {
<a name="l00233"></a>00233                 index_random_records_();
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235         <a class="code" href="classaitools_1_1invertedindex_1_1Logging.html#a4be4729922840b79e1a5620099148926">Logging::log</a>(<span class="stringliteral">&quot;Indexing succeeded.&quot;</span>);
<a name="l00236"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#af6775016223d3da0e56897b10a3828ce">00236</a>         header_.set_indexing_duration(<a class="code" href="classaitools_1_1invertedindex_1_1Logging.html#a0de768ddb7cf8fa02e1b39f07348893e">Logging::time</a>()-header_.indexing_duration());
<a name="l00237"></a>00237         store_header(header_, bfs::path(config.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>()) / header_file);
<a name="l00238"></a>00238         print_header(header_);
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00242"></a>00242 <span class="keywordtype">void</span>
<a name="l00243"></a>00243 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#af6775016223d3da0e56897b10a3828ce">IndexBuilder&lt;Value&gt;::index_random_records_</a>() throw (std::exception)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245         <span class="comment">/* Partition Step: Distribute all records to a number of bucket files.</span>
<a name="l00246"></a>00246 <span class="comment">         */</span>
<a name="l00247"></a>00247         <span class="keyword">const</span> bfs::path bucket_dir(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1c685be2be4a7987852f95142501312b">partition_records_</a>());
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         <span class="comment">/* Shuffle Step: Iterate bucket files, build postlists from records,</span>
<a name="l00250"></a>00250 <span class="comment">         * sort theses postlists and store them on external hard drive.</span>
<a name="l00251"></a>00251 <span class="comment">         */</span>
<a name="l00252"></a>00252         int64_t key_cnt(0);
<a name="l00253"></a>00253         int64_t val_cnt(0);
<a name="l00254"></a>00254         int64_t payload(0);
<a name="l00255"></a>00255         <a class="code" href="classaitools_1_1invertedindex_1_1Quantile.html">Quantile</a> quantile;
<a name="l00256"></a>00256         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8c52685830072275be50f8fea0534464">BuilderMap</a> builders;
<a name="l00257"></a>00257         <a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html">StorageBuilder</a> storage;
<a name="l00258"></a>00258         <a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html">Postlist&lt;Value&gt;</a> postlist;
<a name="l00259"></a>00259         bfs::directory_iterator dend;
<a name="l00260"></a>00260         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a7520978207eeb8f1fe4e1a1aefd56305">open</a>(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>());
<a name="l00261"></a>00261         BuilderMap::const_iterator bend(builders.end());
<a name="l00262"></a>00262         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a2357a8361fc9a15c59e9d3383495a84a">Sorting</a> sort_mode(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#aed00db6b2bea9b3c1606fa307546c2c2">postlist_sorting</a>());
<a name="l00263"></a>00263         <span class="keywordflow">for</span> (bfs::directory_iterator dit(bucket_dir); dit != dend; ++dit)
<a name="l00264"></a>00264         {
<a name="l00265"></a>00265                 <a class="code" href="classaitools_1_1invertedindex_1_1Logging.html#a4be4729922840b79e1a5620099148926">Logging::log</a>(<span class="stringliteral">&quot;Gather Step &quot;</span> + dit-&gt;path().string());
<a name="l00266"></a>00266 
<a name="l00267"></a>00267                 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1051e3bca98ee901a9d46939c11098d9">build_postlists</a>(dit-&gt;path(), builders);
<a name="l00268"></a>00268                 <span class="keywordflow">for</span> (BuilderMap::iterator bit(builders.begin()); bit != bend; ++bit)
<a name="l00269"></a>00269                 {
<a name="l00270"></a>00270                         postlist = bit-&gt;second-&gt;build();
<a name="l00271"></a>00271                         <a class="code" href="classaitools_1_1invertedindex_1_1PostlistSorter.html#afe2ea41184a57e0eda2d3155720b05e2">PostlistSorter::sort</a>(postlist, quantile, sort_mode);
<a name="l00272"></a>00272                         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a1abcad1402d8c5a52ced64358ed7429b">put</a>(bit-&gt;first, postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a24e4956944d63066fc97f2fcabd4ba1d">iterator</a>());
<a name="l00273"></a>00273                         <span class="keywordflow">if</span> (sort_mode != <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a50f6a42dd5b91b4a50670fa4926e486a">Configuration::DISABLED</a>)
<a name="l00274"></a>00274                         {
<a name="l00275"></a>00275                                 storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a1abcad1402d8c5a52ced64358ed7429b">put</a>(bit-&gt;first, quantile);
<a name="l00276"></a>00276                         }
<a name="l00277"></a>00277                         key_cnt++;
<a name="l00278"></a>00278                         val_cnt += postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a3ee4899c38e03e66c6ad15c1c7e08402">length</a>();
<a name="l00279"></a>00279                         payload += postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a9a212e848f29d725fe7242c8455708c4">payload</a>();
<a name="l00280"></a>00280                 }
<a name="l00281"></a>00281                 bfs::remove(dit-&gt;path());
<a name="l00282"></a>00282                 builders.clear();
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>.set_value_count(val_cnt);
<a name="l00285"></a>00285         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>.set_key_count(key_cnt);
<a name="l00286"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a82e8b8f09e4d3f5262c922660bf339fe">00286</a>         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Header.html#a00fcd4eff221175be94af7dca4382a08">set_payload</a>(payload);
<a name="l00287"></a>00287         bfs::remove(bucket_dir);
<a name="l00288"></a>00288         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#aba78df985205dae54ab4f9f7f62c50ff">close</a>();
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00292"></a>00292 <span class="keywordtype">void</span>
<a name="l00293"></a>00293 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a82e8b8f09e4d3f5262c922660bf339fe">IndexBuilder&lt;Value&gt;::index_sorted_records_</a>() throw (std::exception)
<a name="l00294"></a>00294 {
<a name="l00295"></a>00295         int64_t key_cnt(0);
<a name="l00296"></a>00296         int64_t val_cnt(0);
<a name="l00297"></a>00297         int64_t payload(0);
<a name="l00298"></a>00298         std::string key;
<a name="l00299"></a>00299         <a class="code" href="classaitools_1_1invertedindex_1_1Quantile.html">Quantile</a> quantile;
<a name="l00300"></a>00300         <a class="code" href="classaitools_1_1invertedindex_1_1Record.html">Record&lt;Value&gt;</a> record;
<a name="l00301"></a>00301         <a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html">GenericRecord</a> grecord;
<a name="l00302"></a>00302         <a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html">StorageBuilder</a> storage;
<a name="l00303"></a>00303         <a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html">PostlistBuilder</a> builder;
<a name="l00304"></a>00304         <a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html">Postlist&lt;Value&gt;</a> postlist;
<a name="l00305"></a>00305         bfs::directory_iterator end;
<a name="l00306"></a>00306         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a7520978207eeb8f1fe4e1a1aefd56305">open</a>(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>());
<a name="l00307"></a>00307         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a2357a8361fc9a15c59e9d3383495a84a">Sorting</a> sort_mode(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#aed00db6b2bea9b3c1606fa307546c2c2">postlist_sorting</a>());
<a name="l00308"></a>00308         <span class="keywordflow">for</span> (bfs::directory_iterator it(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a575db839688fc03a75d9044c2dd34035">input_directory</a>()); it != end; ++it)
<a name="l00309"></a>00309         {
<a name="l00310"></a>00310                 <a class="code" href="classaitools_1_1invertedindex_1_1Logging.html#a4be4729922840b79e1a5620099148926">Logging::log</a>(<span class="stringliteral">&quot;Gather Step &quot;</span> + it-&gt;path().string());
<a name="l00311"></a>00311 
<a name="l00312"></a>00312                 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>-&gt;open(it-&gt;path());
<a name="l00313"></a>00313                 <span class="keywordflow">while</span> (<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>-&gt;next(record))
<a name="l00314"></a>00314                 {
<a name="l00315"></a>00315                         record.<a class="code" href="classaitools_1_1invertedindex_1_1Record.html#ab05ba1be434595c8e9627826a89a1165">to_generic</a>(grecord);
<a name="l00316"></a>00316                         <span class="keywordflow">if</span> (grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>().size() &gt; <a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#abb10cdce6801ad676a64a96a15530e99">GenericRecord::max_key_size</a>)
<a name="l00317"></a>00317                         {
<a name="l00318"></a>00318                                 <a class="code" href="namespaceaitools_1_1util.html#ad719d80608bf9ca12855bc5d745884e3">Exception::throw_out_of_range</a>(<span class="stringliteral">&quot;Too long key&quot;</span>, record);
<a name="l00319"></a>00319                         }
<a name="l00320"></a>00320                         <span class="keywordflow">if</span> (grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a8e8f2bb476c421c888f788a78a4f02c3">value</a>().size() &gt; <a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a8a5af2abcf5696e5d9df826a1001bffe">GenericRecord::max_val_size</a>)
<a name="l00321"></a>00321                         {
<a name="l00322"></a>00322                                 <a class="code" href="namespaceaitools_1_1util.html#ad719d80608bf9ca12855bc5d745884e3">Exception::throw_out_of_range</a>(<span class="stringliteral">&quot;Too long value&quot;</span>, record);
<a name="l00323"></a>00323                         }
<a name="l00324"></a>00324                         <span class="keywordflow">if</span> (key.empty())
<a name="l00325"></a>00325                         {
<a name="l00326"></a>00326                                 key = grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>();
<a name="l00327"></a>00327                         }
<a name="l00328"></a>00328                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>() != key)
<a name="l00329"></a>00329                         {
<a name="l00330"></a>00330                                 postlist = builder.<a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html#a69815c7a781768b42bd4dd38aafc989b">build</a>();
<a name="l00331"></a>00331                                 <a class="code" href="classaitools_1_1invertedindex_1_1PostlistSorter.html#afe2ea41184a57e0eda2d3155720b05e2">PostlistSorter::sort</a>(postlist, quantile, sort_mode);
<a name="l00332"></a>00332                                 storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a1abcad1402d8c5a52ced64358ed7429b">put</a>(key, postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a24e4956944d63066fc97f2fcabd4ba1d">iterator</a>());
<a name="l00333"></a>00333                                 <span class="keywordflow">if</span> (sort_mode != <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a50f6a42dd5b91b4a50670fa4926e486a">Configuration::DISABLED</a>)
<a name="l00334"></a>00334                                 {
<a name="l00335"></a>00335                                         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a1abcad1402d8c5a52ced64358ed7429b">put</a>(key, quantile);
<a name="l00336"></a>00336                                 }
<a name="l00337"></a>00337                                 key_cnt++;
<a name="l00338"></a>00338                                 val_cnt += postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a3ee4899c38e03e66c6ad15c1c7e08402">length</a>();
<a name="l00339"></a>00339                                 payload += postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a9a212e848f29d725fe7242c8455708c4">payload</a>();
<a name="l00340"></a>00340                                 builder.<a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html#ac191f54a59904f7ec927bcd957cb1969">set_checksum</a>(<a class="code" href="classaitools_1_1invertedindex_1_1Checksum.html#ade4ac3b5e85fc603d9663816bec616f8">Checksum::hash16</a>(grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>()));
<a name="l00341"></a>00341                                 key = grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a3aed896298074f80ad4f9e3adf9eab74">key</a>();
<a name="l00342"></a>00342                         }
<a name="l00343"></a>00343                         builder.<a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html#a4e3754c86600a439e1675e99de549246">append</a>(grecord.<a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a8e8f2bb476c421c888f788a78a4f02c3">value</a>());
<a name="l00344"></a>00344                 }
<a name="l00345"></a>00345                 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>-&gt;close();
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347         postlist = builder.<a class="code" href="classaitools_1_1invertedindex_1_1PostlistBuilder.html#a69815c7a781768b42bd4dd38aafc989b">build</a>();
<a name="l00348"></a>00348         <a class="code" href="classaitools_1_1invertedindex_1_1PostlistSorter.html#afe2ea41184a57e0eda2d3155720b05e2">PostlistSorter::sort</a>(postlist, quantile, sort_mode);
<a name="l00349"></a>00349         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a1abcad1402d8c5a52ced64358ed7429b">put</a>(key, postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a24e4956944d63066fc97f2fcabd4ba1d">iterator</a>()); <span class="comment">// put last</span>
<a name="l00350"></a>00350         <span class="keywordflow">if</span> (sort_mode != <a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a50f6a42dd5b91b4a50670fa4926e486a">Configuration::DISABLED</a>)
<a name="l00351"></a>00351         {
<a name="l00352"></a>00352                 storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#a1abcad1402d8c5a52ced64358ed7429b">put</a>(key, quantile);
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354         key_cnt++;
<a name="l00355"></a>00355         val_cnt += postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a3ee4899c38e03e66c6ad15c1c7e08402">length</a>();
<a name="l00356"></a>00356         payload += postlist.<a class="code" href="classaitools_1_1invertedindex_1_1Postlist.html#a9a212e848f29d725fe7242c8455708c4">payload</a>();
<a name="l00357"></a>00357         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>.set_value_count(val_cnt);
<a name="l00358"></a><a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1c685be2be4a7987852f95142501312b">00358</a>         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Header.html#a70486ffb05fffb283a829a3b6fd14c08">set_key_count</a>(key_cnt);
<a name="l00359"></a>00359         <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1d2e34dec278adf4f4872d089ae4be0f">header_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Header.html#a00fcd4eff221175be94af7dca4382a08">set_payload</a>(payload);
<a name="l00360"></a>00360         storage.<a class="code" href="classaitools_1_1invertedindex_1_1StorageBuilder.html#aba78df985205dae54ab4f9f7f62c50ff">close</a>();
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;
<a name="l00364"></a>00364 bfs::path
<a name="l00365"></a>00365 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a1c685be2be4a7987852f95142501312b">IndexBuilder&lt;Value&gt;::partition_records_</a>() throw (std::exception)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367         <span class="comment">// create tmp files as buckets</span>
<a name="l00368"></a>00368         <span class="keyword">const</span> bfs::path bucket_dir(bfs::path(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ad61fa2d25c585943d5409c94e4a96616">index_directory</a>()) / <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a8a430030bcc9af7f753cd5f2eebca269">tmp_dir</a>);
<a name="l00369"></a>00369         <span class="keyword">const</span> uint64_t payload(<a class="code" href="classaitools_1_1invertedindex_1_1System.html#a87eb83ded323d9018b9ec79cb7b5a234">System::directory_size</a>(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#a575db839688fc03a75d9044c2dd34035">input_directory</a>()));
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#aa1ce48a05c3f84b7c69b7d406b52db8a">available_memory</a>() &lt; 1000) <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#ae2dbdf5e697e2c1cc80ae8f0be3d36c6">set_available_memory</a>(1000);
<a name="l00371"></a>00371         <span class="keywordtype">unsigned</span> bucket_count(payload / (700000 * <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.<a class="code" href="classaitools_1_1invertedindex_1_1Configuration.html#aa1ce48a05c3f84b7c69b7d406b52db8a">available_memory</a>()));
<a name="l00372"></a>00372         bucket_count = <a class="code" href="namespaceaitools_1_1util.html#a621ddd5bdc142bd06a0b4cb487450e5a">Checksum::next_prime</a>(bucket_count);
<a name="l00373"></a>00373         std::vector&lt;FILE*&gt; bucket_files(bucket_count);
<a name="l00374"></a>00374         bfs::create_directory(bucket_dir);
<a name="l00375"></a>00375         std::string bucket_file_name;
<a name="l00376"></a>00376         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i(0); i != bucket_count; ++i)
<a name="l00377"></a>00377         {
<a name="l00378"></a>00378                 bucket_file_name = <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#ad3d1129f6bf0a1c9a3427c1b777d6680">tmp_file</a> + <a class="code" href="classaitools_1_1invertedindex_1_1Converter.html#a0354f81b8d88348b43d07d54f246659b">Converter::ui32_to_str</a>(i);
<a name="l00379"></a>00379                 bucket_files[i] = <a class="code" href="namespaceaitools_1_1util.html#a1a7eda380ed6a1c7f779c4cbe0efda97">System::fopen</a>(bucket_dir / bucket_file_name, <span class="stringliteral">&quot;wb&quot;</span>);
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="comment">// read records and partition them</span>
<a name="l00383"></a>00383         uint32_t checksum;
<a name="l00384"></a>00384         Record&lt;Value&gt; record;
<a name="l00385"></a>00385         GenericRecord gen_record;
<a name="l00386"></a>00386         <span class="keyword">const</span> bfs::directory_iterator end;
<a name="l00387"></a>00387         <span class="keywordflow">for</span> (bfs::directory_iterator it(<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#adbc057a2e96ad206437f308214649f2d">config_</a>.input_directory()); it != end; ++it)
<a name="l00388"></a>00388         {
<a name="l00389"></a>00389                 <a class="code" href="classaitools_1_1invertedindex_1_1Logging.html#a4be4729922840b79e1a5620099148926">Logging::log</a>(<span class="stringliteral">&quot;Scatter Step &quot;</span> + it-&gt;path().string());
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>-&gt;open(it-&gt;path());
<a name="l00392"></a>00392                 <span class="keywordflow">while</span> (<a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>-&gt;next(record))
<a name="l00393"></a>00393                 {
<a name="l00394"></a>00394                         record.to_generic(gen_record);
<a name="l00395"></a>00395                         <span class="keywordflow">if</span> (gen_record.key().size() &gt; <a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#abb10cdce6801ad676a64a96a15530e99">GenericRecord::max_key_size</a>)
<a name="l00396"></a>00396                         {
<a name="l00397"></a>00397                                 <a class="code" href="namespaceaitools_1_1util.html#ad719d80608bf9ca12855bc5d745884e3">Exception::throw_out_of_range</a>(<span class="stringliteral">&quot;Too long key&quot;</span>, record);
<a name="l00398"></a>00398                         }
<a name="l00399"></a>00399                         <span class="keywordflow">if</span> (gen_record.value().size() &gt; <a class="code" href="classaitools_1_1invertedindex_1_1GenericRecord.html#a8a5af2abcf5696e5d9df826a1001bffe">GenericRecord::max_val_size</a>)
<a name="l00400"></a>00400                         {
<a name="l00401"></a>00401                                 <a class="code" href="namespaceaitools_1_1util.html#ad719d80608bf9ca12855bc5d745884e3">Exception::throw_out_of_range</a>(<span class="stringliteral">&quot;Too long value&quot;</span>, record);
<a name="l00402"></a>00402                         }
<a name="l00403"></a>00403                         checksum = <a class="code" href="namespaceaitools_1_1util.html#ac92eb9a48df20d2f088d047c82272ee2">Checksum::hash32</a>(gen_record.key());
<a name="l00404"></a>00404                         gen_record.write(bucket_files[checksum % bucket_count]);
<a name="l00405"></a>00405                 }
<a name="l00406"></a>00406                 <a class="code" href="classaitools_1_1invertedindex_1_1IndexBuilder.html#a51f51ef9910b44cbd722156e181c7fb7">reader_</a>-&gt;close();
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="comment">// close bucket files</span>
<a name="l00410"></a>00410         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i(0); i != bucket_count; ++i)
<a name="l00411"></a>00411         {
<a name="l00412"></a>00412                 <a class="code" href="namespaceaitools_1_1util.html#a99e1ca204b3d1a8be4d39c7846005b7d">System::fclose</a>(bucket_files[i]);
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414         <span class="keywordflow">return</span> bucket_dir;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 } <span class="comment">// namespace invertedindex</span>
<a name="l00418"></a>00418 } <span class="comment">// namespace aitools</span>
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="preprocessor">#endif // AITOOLS_INVERTEDINDEX_INDEX_BUILDER_HPP</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed May 30 15:07:25 2012 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
